<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Image ZIP Downloader</title>
<style>
:root {
    --bg: #f4f4f5; --fg: #0f172a; --card: #fff; --muted: #64748b; --accent: #2563eb;
}
[data-theme="dark"] { --bg: #0f172a; --fg: #e5e7eb; --card: #020617; --muted: #94a3b8; --accent: #3b82f6; }
body { margin:0; font-family:system-ui; background:var(--bg); color:var(--fg);}
.container { max-width:820px; margin:40px auto; padding:24px; background:var(--card); border-radius:14px; }
header { display:flex; justify-content:space-between; align-items:center; }
textarea { width:100%; height:260px; background:var(--bg); color:var(--fg); border:1px solid var(--muted); border-radius:8px; padding:12px; font-family:monospace; }
.progress { height:10px; background:#1e293b; border-radius:99px; overflow:hidden; margin-top:16px; display:none; }
.progress > div { height:100%; width:0%; background:var(--accent); transition:width 0.3s; }
button { margin-top:12px; padding:10px 16px; border-radius:6px; border:none; cursor:pointer; background:var(--accent); color:white; }
.status { margin-top:10px; color:var(--muted); }
</style>
</head>
<body>
<div class="container">
<header>
    <h2>Image ZIP Downloader</h2>
    <button id="theme">ðŸŒ™</button>
</header>

<textarea id="input" placeholder="filename.jpg;https://example.com/image.jpg"></textarea>

<button id="start">Download ZIP</button>
<button id="cancel" hidden>Cancel</button>

<div class="progress"><div></div></div>
<div class="status" id="status"></div>
</div>

<script>
const root = document.documentElement;
root.dataset.theme = localStorage.theme || (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light");
document.getElementById("theme").onclick = () => {
    const t = root.dataset.theme === "dark" ? "light" : "dark";
    root.dataset.theme = t;
    localStorage.theme = t;
};

const bar = document.querySelector(".progress > div");
const progressBox = document.querySelector(".progress");
const status = document.getElementById("status");
let jobId, es;

document.getElementById("start").onclick = async () => {
    progressBox.style.display = "block"; 
    bar.style.width = "0%"; 
    status.textContent = "Startingâ€¦";

    const res = await fetch("/job", { 
        method:"POST", 
        headers:{"Content-Type":"application/json"}, 
        body:JSON.stringify({images:input.value}) 
    });
    ({ id: jobId } = await res.json());

    es = new EventSource(`/progress/${jobId}`);
    let firstUpdate = false;

    es.onmessage = e => {
        const msg = JSON.parse(e.data);

        if (!firstUpdate) {
            firstUpdate = true;
            status.textContent = "";
        }

        if(msg.type==="file"){
            const percent = (msg.done/msg.total)*100;
            bar.style.width = percent+"%";
            const remaining = msg.total-msg.done;
            const etaMs = remaining*msg.avgMs;
            const mins = Math.floor(etaMs/60000); 
            const secs = Math.floor((etaMs%60000)/1000);
            status.textContent=`Downloaded ${msg.done}/${msg.total} â€” ETA: ${mins}m ${secs}s`;
        }
        if(msg.type==="zip") status.textContent="Creating ZIPâ€¦";
        if(msg.type==="done") {
            status.textContent="Finished!";
            bar.style.width="100%";
        }
        if(msg.type==="error") status.textContent="Error occurred!";
    };

    window.location=`/download/${jobId}`;
};

document.getElementById("cancel").onclick = () => {
    fetch(`/cancel/${jobId}`,{method:"POST"});
    es?.close(); 
    status.textContent="Canceled.";
};
</script>

</body>
</html>
